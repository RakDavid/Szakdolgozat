<div class="event-detail-container" *ngIf="!loading && event" [style.backgroundImage]="getDynamicBackground(event.sport_type_detail?.name)">
  <div class="event-hero" [style.background-image]="event.images && event.images.length > 0 ? 'url(' + event.images[0].image + ')' : 'none'">
    <div class="hero-overlay">
      <div class="hero-content">
        <div class="event-badges">
          <span class="badge badge-sport">{{ event.sport_type_detail?.name }}</span>
          <span class="badge badge-difficulty" [class]="event.difficulty">
            {{ getDifficultyLabel(event.difficulty) }}
          </span>
          <span class="badge badge-status" [class]="event.status">
            {{ getStatusLabel(event.status) }}
          </span>
        </div>
        <h1 class="event-title">{{ event.title }}</h1>
      </div>
    </div>
  </div>

  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="alert alert-error">
    {{ errorMessage }}
  </div>

  <div class="event-content">
    
    <div class="event-main">
      
      <div class="info-cards">
        <div class="info-card">
          <div class="info-icon">üìÖ</div>
          <div class="info-content">
            <div class="info-label">Id≈ëpont</div>
            <div class="info-value">{{ getEventDate(event.start_date_time) }}</div>
            <div class="info-subvalue">{{ getEventTime(event.start_date_time) }}</div>
          </div>
        </div>

        <div class="info-card">
          <div class="info-icon">üìç</div>
          <div class="info-content">
            <div class="info-label">Helysz√≠n</div>
            <div class="info-value">{{ event.location_name }}</div>
            <div class="info-subvalue" *ngIf="event.location_address" [title]="event.location_address">
              {{ formatShortAddress(event.location_address) }}
            </div>
          </div>
        </div>

        <div class="info-card">
          <div class="info-icon">üë•</div>
          <div class="info-content">
            <div class="info-label">R√©sztvev≈ëk</div>
            <div class="info-value">{{ event.participants_count }} / {{ event.max_participants }}</div>
            <div class="info-subvalue" [class.full]="event.is_full">
              {{ event.is_full ? 'Betelt' : event.available_spots + ' szabad hely' }}
            </div>
          </div>
        </div>

        <div class="info-card">
          <div class="info-icon">üí∞</div>
          <div class="info-content">
            <div class="info-label">R√©szv√©teli d√≠j</div>
            <div class="info-value">{{ event.is_free ? 'Ingyenes' : event.price + ' Ft' }}</div>
          </div>
        </div>
      </div>

      <div class="section-card">
        <h2 class="section-title">Le√≠r√°s</h2>
        <p class="event-description">{{ event.description }}</p>
      </div>

      <div class="section-card" *ngIf="event.notes">
        <h2 class="section-title">Tov√°bbi inform√°ci√≥k</h2>
        <p class="event-notes">{{ event.notes }}</p>
      </div>

      <div class="section-card">
        <h2 class="section-title">T√©rk√©p</h2>
        <app-map 
          [latitude]="event.latitude" 
          [longitude]="event.longitude"
          [height]="'400px'"
          [markers]="[{lat: event.latitude, lng: event.longitude, popup: event.location_name}]"
        ></app-map>
      </div>

      <div class="section-card">
        <h2 class="section-title">R√©sztvev≈ëk ({{ participants.length }})</h2>
        <div class="participants-list" *ngIf="participants.length > 0">
          <div class="participant-item" *ngFor="let participant of participants" style="cursor: pointer;" [routerLink]="['/users', participant.user]">
            <div class="participant-avatar">
              <img *ngIf="participant.user_detail?.profile_picture" [src]="participant.user_detail?.profile_picture" alt="Avatar" />
              <span *ngIf="!participant.user_detail?.profile_picture">
                {{ participant.user_detail?.last_name?.charAt(0) }}{{ participant.user_detail?.first_name?.charAt(0) }}
              </span>
            </div>
            <div class="participant-info">
              <div class="participant-name-row">
                <span class="participant-name">{{ participant.user_detail?.full_name }}</span>
                <span *ngIf="participant.user === event.creator" class="creator-badge-small">
                  üëë Szervez≈ë
                </span>
              </div>
              <div class="participant-status" [class]="participant.status" *ngIf="participant.status !== 'confirmed'">
                {{ getParticipantStatusLabel(participant.status) }}
              </div>
            </div>
          </div>
        </div>
        <p *ngIf="participants.length === 0" class="no-participants">
          M√©g nincs r√©sztvev≈ë. L√©gy te az els≈ë!
        </p>
      </div>
      
      <div class="rating-summary-card" *ngIf="event?.average_rating">
        <div class="rating-content">
          <div class="rating-number">
            <span class="score">{{ event.average_rating }}</span>
            <span class="max">/ 5</span>
          </div>
          <div class="rating-stars">
            <span class="star-icon">‚òÖ</span>
            <span class="rating-text">√Åtlagos √©rt√©kel√©s</span>
          </div>
        </div>
      </div>

      <hr class="section-divider">

      <div class="feedbacks-container" *ngIf="event?.participants">
        <h3 class="detail-subtitle">Visszajelz√©sek</h3>
        
        <div class="feedback-grid">
          <ng-container *ngFor="let p of event.participants">
            <div class="feedback-item" *ngIf="p.rating || p.feedback">
              <div class="feedback-header">
                <div class="user-meta">
                  <span class="feedback-user">{{ p.user_detail?.username }}</span>
                  <span class="feedback-date">{{ p.joined_at | date:'yyyy. MM. dd.' }}</span>
                </div>
                <div class="feedback-rating">
                  <span class="star filled" *ngFor="let i of [1,2,3,4,5]" 
                        [class.active]="i <= (p.rating || 0)">‚òÖ</span>
                </div>
              </div>
              <div class="feedback-content" *ngIf="p.feedback">
                <p>"{{ p.feedback }}"</p>
              </div>
            </div>
          </ng-container>
        </div>

        <div class="empty-feedbacks" *ngIf="!event?.average_rating">
          <p>M√©g nem √©rkezett √©rt√©kel√©s erre az esem√©nyre.</p>
        </div>
      </div>

    </div> 
    <div class="event-sidebar">
      
      <div class="action-card">
        
        <div *ngIf="isCreator" class="creator-actions">
          <h3>Saj√°t esem√©ny</h3>
          <p class="action-description">Te hoztad l√©tre ezt az esem√©nyt</p>
          
          <div *ngIf="pendingParticipants.length > 0" class="pending-section">
            <h4 class="pending-title">
              ‚è≥ F√ºgg≈ëben l√©v≈ë k√©r√©sek ({{ pendingParticipants.length }})
            </h4>
            <div *ngFor="let p of pendingParticipants" class="pending-item">
              <div class="pending-info">
                <div class="pending-name">{{ p.user_detail?.full_name }}</div>
                <div class="pending-username">{{ '@' + p.user_detail?.username }}</div>
                <div *ngIf="p.notes" class="pending-notes">üí¨ "{{ p.notes }}"</div>
                <div class="pending-time">{{ p.joined_at | date:'MMM d, HH:mm' }}</div>
              </div>
              <div class="pending-actions" *ngIf="!event.is_past">
                <button class="btn btn-success btn-small" (click)="approveParticipant(p.id)">
                  ‚úì J√≥v√°hagy√°s
                </button>
                <button class="btn btn-danger btn-small" (click)="rejectParticipant(p.id)">
                  ‚úï Elutas√≠t√°s
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="pendingParticipants.length === 0 && event.requires_approval" class="no-pending">
            Nincs f√ºgg≈ëben l√©v≈ë k√©r√©s
          </div>

          <div class="creator-btn-group" *ngIf="!event.is_past">
            <button class="btn btn-outline btn-block" (click)="editEvent()">
              ‚úèÔ∏è Szerkeszt√©s
            </button>
            <button class="btn btn-danger btn-block" (click)="deleteEvent()">
              üóëÔ∏è T√∂rl√©s
            </button>
          </div>
        </div>

        <div *ngIf="!isCreator">

          <div class="rating-section" *ngIf="canRateEvent() && !ratingSuccess" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px;">            
            <h3 style="margin-bottom: 15px; font-size: 1.2rem;">√ârt√©keld az esem√©nyt!</h3>
            <div *ngIf="ratingError" class="alert alert-error">{{ ratingError }}</div>

            <div class="stars" style="font-size: 2rem; cursor: pointer; color: #ccc; margin-bottom: 15px;">
              <span (click)="setRating(1)" [style.color]="ratingValue >= 1 ? '#FFD700' : '#ccc'">‚òÖ</span>
              <span (click)="setRating(2)" [style.color]="ratingValue >= 2 ? '#FFD700' : '#ccc'">‚òÖ</span>
              <span (click)="setRating(3)" [style.color]="ratingValue >= 3 ? '#FFD700' : '#ccc'">‚òÖ</span>
              <span (click)="setRating(4)" [style.color]="ratingValue >= 4 ? '#FFD700' : '#ccc'">‚òÖ</span>
              <span (click)="setRating(5)" [style.color]="ratingValue >= 5 ? '#FFD700' : '#ccc'">‚òÖ</span>
            </div>

            <textarea 
              [(ngModel)]="feedbackText" 
              placeholder="√çrj egy r√∂vid sz√∂veges √©rt√©kel√©st (opcion√°lis)..." 
              class="form-control" 
              rows="3" 
              style="width: 100%; margin-bottom: 15px;">
            </textarea>

            <button 
              class="btn btn-primary" 
              (click)="submitRating()" 
              [disabled]="ratingValue === 0 || isSubmittingRating">
              <span *ngIf="!isSubmittingRating">‚≠ê √ârt√©kel√©s bek√ºld√©se</span>
              <span *ngIf="isSubmittingRating">K√ºld√©s...</span>
            </button>
          </div>

          <div class="alert alert-success" *ngIf="ratingSuccess" style="margin-top: 30px;">
            K√∂sz√∂nj√ºk az √©rt√©kel√©st!
          </div>
          
          <div *ngIf="canJoinEvent() && !showJoinForm">
            <h3>Csatlakozz!</h3>
            <p class="action-description">
              {{ event.requires_approval ? 'Jelentkez√©sed j√≥v√°hagy√°sra v√°r' : 'Azonnal csatlakozhatsz' }}
            </p>
            <button class="btn btn-primary btn-block" (click)="toggleJoinForm()" [disabled]="event.is_full">
              {{ event.is_full ? '‚ùå Betelt' : '‚úÖ Jelentkez√©s' }}
            </button>
          </div>

          <div *ngIf="showJoinForm" class="join-form">
            <h3>Jelentkez√©s</h3>
            <div class="form-group">
              <label>√úzenet a szervez≈ënek (opcion√°lis)</label>
              <textarea
                [(ngModel)]="joinNotes"
                placeholder="Pl: Kezd≈ë vagyok, de szeretn√©k tanulni..."
                rows="4"
                class="form-control"
              ></textarea>
            </div>
            <button class="btn btn-primary btn-block" (click)="joinEvent()" [disabled]="joining">
              <span *ngIf="!joining">Jelentkez√©s</span>
              <span *ngIf="joining">Jelentkez√©s...</span>
            </button>
            <button class="btn btn-outline btn-block" (click)="toggleJoinForm()" [disabled]="joining">
              M√©gse
            </button>
          </div>

          <div *ngIf="event.user_participation_status">
            <h3>R√©szt veszel</h3>
            <p class="action-description">
              St√°tusz: {{ getParticipantStatusLabel(event.user_participation_status.status) }}
            </p>
            <button 
              *ngIf="canLeaveEvent()" 
              class="btn btn-danger btn-block" 
              (click)="leaveEvent()" 
              [disabled]="leaving"
            >
              <span *ngIf="!leaving">‚ùå Lemond√°s</span>
              <span *ngIf="leaving">Lemond√°s...</span>
            </button>
          </div>
        </div>

        <div class="details-summary">
          <div class="summary-item">
            <span class="summary-label">‚è±Ô∏è Id≈ëtartam:</span>
            <span class="summary-value">{{ event.duration_minutes || '-' }} perc</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">üìä Min. l√©tsz√°m:</span>
            <span class="summary-value">{{ event.min_participants }} f≈ë</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">üìù J√≥v√°hagy√°s:</span>
            <span class="summary-value">{{ event.requires_approval ? 'Sz√ºks√©ges' : 'Automatikus' }}</span>
          </div>
        </div>
      </div> <button class="btn btn-outline btn-block" routerLink="/events">
        ‚Üê Vissza az esem√©nyekhez
      </button>

    </div> 
    </div> </div> <div *ngIf="loading" class="loading-container">
  <div class="spinner"></div>
  <p>Esem√©ny bet√∂lt√©se...</p>
</div>